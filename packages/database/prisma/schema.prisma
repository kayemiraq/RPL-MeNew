generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum Role {
  SUPER_ADMIN
  OWNER
  MANAGER
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum SubscriptionPlan {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  SERVED
  CANCELLED
}

// ============================================================
// USER & AUTH
// ============================================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  password     String
  name         String
  role         Role
  refreshToken String?  @db.Text

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Many-to-many: a user can manage multiple stores
  stores UserStore[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

model UserStore {
  id      String @id @default(uuid())
  userId  String
  storeId String

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@unique([userId, storeId])
  @@map("user_stores")
}

// ============================================================
// TENANT (Multi-Tenancy Root)
// ============================================================

model Tenant {
  id     String       @id @default(uuid())
  name   String
  slug   String       @unique
  logo   String?
  status TenantStatus @default(ACTIVE)

  subscription Subscription?
  users        User[]
  stores       Store[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tenants")
}

model Subscription {
  id        String           @id @default(uuid())
  plan      SubscriptionPlan @default(FREE)
  maxStores Int              @default(1)
  startsAt  DateTime         @default(now())
  expiresAt DateTime?

  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("subscriptions")
}

// ============================================================
// STORE & TABLE
// ============================================================

model Store {
  id          String  @id @default(uuid())
  name        String
  slug        String
  address     String?
  phone       String?
  logo        String?
  description String? @db.Text
  isActive    Boolean @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  tables     Table[]
  categories Category[]
  products   Product[]
  orders     Order[]
  managers   UserStore[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("stores")
}

model Table {
  id          String  @id @default(uuid())
  number      Int
  label       String? // e.g., "Window Seat A3"
  qrCodeUrl   String? @db.Text
  isOccupied  Boolean @default(false)

  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  orders Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, number])
  @@index([storeId])
  @@map("tables")
}

// ============================================================
// MENU: CATEGORY & PRODUCT
// ============================================================

model Category {
  id          String  @id @default(uuid())
  name        String
  slug        String
  description String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, slug])
  @@index([storeId])
  @@map("categories")
}

model Product {
  id          String  @id @default(uuid())
  name        String
  slug        String
  description String? @db.Text
  price       Decimal @db.Decimal(12, 2)
  image       String?
  isAvailable Boolean @default(true)
  sortOrder   Int     @default(0)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, slug])
  @@index([storeId])
  @@index([categoryId])
  @@map("products")
}

// ============================================================
// ORDERS
// ============================================================

model Order {
  id          String      @id @default(uuid())
  orderNumber String      @unique
  status      OrderStatus @default(PENDING)
  totalAmount Decimal     @db.Decimal(12, 2)
  notes       String?     @db.Text
  guestName   String?

  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  tableId String?
  table   Table?  @relation(fields: [tableId], references: [id], onDelete: SetNull)

  items OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId])
  @@index([storeId, createdAt])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id       String  @id @default(uuid())
  quantity Int
  price    Decimal @db.Decimal(12, 2)
  notes    String?

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}
